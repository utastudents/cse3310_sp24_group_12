<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
    </head>
    <title>TWSG</title>

    <body class="bg-dark text-white">
        <nav class="navbar navbar-dark  d-flex border-bottom border-white">
            <div class="container-fluid justify-content-evenly position-relative pt-3 pb-3">
                <h1
                    id="TWSG"
                    class="navbar-brand font-weight-bold extra-bold position-absolute start-50 translate-middle-x "
                    title="The World Search Game"
                    style="font-size: 2em"
                >
                    TWSG
                </h1>
                <button id="Chat" class="btn btn-primary ms-auto mx-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasBottom" aria-controls="offcanvasBottom" style="display: none;">OPEN CHAT</button>
            </div>
        </nav>

        <div class="offcanvas offcanvas-bottom bg-dark mx-auto" tabindex="-1" id="offcanvasBottom" aria-labelledby="offcanvasBottomLabel" style="width: 1000px; height: 700px; overflow: hidden">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasBottomLabel">CHAT</h5>
              <button type="button" class="btn-close bg-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div  class="offcanvas-body small position-relative">
                <div class="bg-secondary position-relative" style="overflow-x: hidden; overflow-y: auto; max-height: 500px; height: 500px; width: 950px; border-radius: 5px;">
                    <ul  id="chatLog" class="list-group pt-2 mx-2 position-absolute bottom-0 start-0 ">
                        
                    </ul>
                </div>
                <span class="position-absolute start-50 translate-middle-x fs-3 "> Enter Message</span>
                <form id="hit-send">
                    <input class="position-absolute  my-5 start-50 translate-middle-x w-50 text-break form" type="text"  id="MessageInput" />
                    <button type="submit" class="btn btn-primary my-5 position-absolute start-50 translate-middle-x" style="translate: 300px;" >SEND</button>
                </form>
            </div>
        </div>
       






        <!--Login Screen Here -->
        <div id="LoginScreen" style="display: block">
            <div class="container-fluid row g-3 py-2 justify-content-center">
                <form id="usernameForm" class="col-6 text-center">
                    <div class="row mb-2">
                        <h3>
                            <label for="inputUsername" class="col-form-label">
                                Enter Username
                            </label>
                        </h3>
                    </div>
                    <div>
                        <input
                            type="text"
                            id="inputUsername"
                            class="form-control"
                        />
                    </div>
                    <div>
                        <span id="nameLength" class="form-text">
                            Must be atleast 3 characters.
                        </span>
                    </div>
                    <div>
                        <span id="usernameError" class="form-text text-danger">
                        </span>
                    </div>
                    <button
                        type="submit"
                        class="btn btn-primary mt-2"
                        style="width: 30%"
                    >
                        SUBMIT
                    </button>
                </form>
            </div>
        </div>

        <!--Lobby Screen Here -->
        <div id="LobbyScreen" style="display: none">
            <div class="container text-center mt-3">
                <h2>L O B B Y</h2>
            </div>

            <div
                class="d-flex align-items-center col card bg-secondary mx-auto mt-5"
                style="max-height: 300px; width: 300px"
            >
                <ul
                    id="usernameList"
                    class="list-group flex-grow-1"
                    style="height: 100%; width: 100%"
                ></ul>
            </div>
            <div
                class="d-flex justify-content-center align-items-center col mx-auto"
                style="max-height: 300px; width: 300px"
            >
                <button
                    id="startButton"
                    type="button"
                    class="btn btn-primary mt-2"
                    style="width: 50%; display: 'block'"
                >
                    START GAME
                </button>
                <div id="Countdown" class="mt-4" style="display: none">
                    Game starts in
                    <span
                        id="Count"
                        class="text-danger"
                        style="font-weight: bolder"
                        >10</span
                    >
                </div>
            </div>
        </div>
        <div id="GameScreen" class="container-fluid mt-5" style="display: none">
            <div class="row justify-content-start">
                <div class="col-10">
                    <div
                        id="WordGrid"
                        class="d-flex card bg-secondary p-3 align-items-center justify-content-start"
                        style="
                            width: 100%;
                            height: 100%;
                            overflow-x: auto;
                            overflow-y: auto;
                        "
                    ></div>
                </div>
                <div class="col-1">
                    <div
                        class="position-fixed d-flex card bg-secondary mx-5"
                        style="max-height: 300px; width: 200px"
                    >
                        <ul
                            id="GameuserList"
                            class="list-group flex-grow-1"
                            style="height: 100%; width: 100%"
                        ></ul>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script>
    var idx = -1;
    var gameid = -1;
    class UserEvent {
        Button = -1;
        PlayerIdx = 0;
        GameId = 0;
    }
    var connection = null;

    var serverUrl;
    serverUrl =
        "ws://" +
        window.location.hostname +
        ":" +
        (parseInt(location.port) + 100);
    // Create the connection with the server
    connection = new WebSocket(serverUrl);

    connection.onopen = function (evt) {
        console.log("open");
    };
    connection.onclose = function (evt) {
        console.log("close");
    };
    const LoginScreen = document.getElementById("LoginScreen");
    const LobbyScreen = document.getElementById("LobbyScreen");
    const chat = document.getElementById("Chat")
    const chatbox = document.getElementById("chatLog");
    const Send = document.getElementById("hit-send")
    const MessageIn = document.getElementById("MessageInput")
    var username;
    var form = document.getElementById("usernameForm");
    var input = document.getElementById("inputUsername");
    var usernameError = document.getElementById("usernameError");
    var nameLength = document.getElementById("nameLength");
    var startButton = document.getElementById("startButton");
    var GameScreen = document.getElementById("GameScreen");
    var buttonsList;
    var chatLog;
    var scoremap = new Map();
    var started = false;
    var userStartClick = null;
    var userEndClick = null;
    let colormap = {
        RED: "Tomato",
        GREEN: "MediumSeaGreen",
        BLUE: "DodgerBlue",
        ORANGE: "Orange",
        YELLOW: "yellow",
        PURPLE: "purple",
        WHITE: "white",
    };
    const gridSize = 40;
    const wordGrid = document.getElementById("WordGrid");


    connection.onmessage = function (evt) {
        var msg;
        msg = evt.data;

        console.log("Message received: " + msg);

        usernameError.textContent = "";
        
        if (msg == "startGame") {
            startCountdown();
            return;
        }


        if (msg.startsWith("!")) {
            if (msg.slice(1, msg.length) == "Invalid Username") {
                usernameError.textContent = "Username in use.";
                return;
            }
            if (msg.slice(1, msg.length) == "Too Short") {
                nameLength.classList.add("text-danger");
                return;
            }
        } else {
            const obj = JSON.parse(msg);

            if ("YouAre" in obj) {
                if (obj.YouAre == "player_1") {
                    idx = 0;
                } else if (obj.YouAre == "player_2") {
                    idx = 1;
                } else if (obj.YouAre == "player_3") {
                    idx = 2;
                } else if (obj.YouAre == "player_4") {
                    idx = 3;
                }
                gameid = obj.GameId;
            }
            if (
                "gameState" in obj &&
                obj.gameState == 1 &&
                obj.GameId == gameid &&
                !started

            ) {
                
                startButton.style.display = "none";
                console.log("gameid: " + gameid);
                console.log("gameState: " + obj.gameState);
                startCountdown();
            }
            if ("loginManager" in obj && obj.GameId == gameid && !started) {
                usernameList = obj.loginManager.usernames;
                usernameList = new Map(Object.entries(usernameList));
                console.log("gameid: " + gameid);
                console.log("usernamelist: " + usernameList);
                if (usernameList.has(username)) {
                    LoginScreen.style.display = "none";
                    LobbyScreen.style.display = "block";
                    chat.style.display = "block";
                    input.value = "";
                    Lobby(usernameList);
                    
                }
            }
            if ("grid" in obj && obj.GameId == gameid) {
                console.log("gameid: " + gameid);
                buttonsList = obj.grid.grid;
                colorIn();

            }
            if ("scores" in obj && obj.GameId == gameid) {
                scoremap = obj.scores.score;
            }
            
            if ("latestPlayer" in obj && obj.GameId == gameid && obj.gameState !=1) {
                if (
                    obj.latestPlayer == "player_1" ||
                    obj.latestPlayer == "player_5"
                ) {
                    startButton.style.display = "none";
                } else {
                    startButton.style.display = "block";
                }
            }

            if("chatLog" in obj && obj.GameId == gameid){
                chatLog = obj.chatLog.chatLog;
                if(chatLog.length === 0){
                    console.log("Empty chat")
                }else{
                    fillChat();
                }
            }
            

            
            
        }
    };

    form.addEventListener("submit", function (e) {
        //take in user input (username)
        e.preventDefault();
        username = input.value;
        connection.send("+" + username);
    });

    Send.addEventListener("submit", function(e){
        e.preventDefault();
        if(MessageIn.value !== " "){
            connection.send("~ " + username + " " + MessageIn.value)
        } 
    })



    function Lobby(usernameList) {
        //lobby screen, for each username in usernamelist create new list element and populate the lobby list.

        if (usernameList) {
            for (let [key, value] of usernameList) {
                if (!document.getElementById(key)) {
                    let listItem = document.createElement("li");
                    listItem.classList.add("list-group-item", "text-center");
                    listItem.style.width = "100%";
                    listItem.style.height = "60px";
                    listItem.style.fontWeight = "bold";
                    // listItem.style.backgroundColor = colormap[value];
                    listItem.textContent = key.toUpperCase();
                    listItem.id = key;
                    document
                        .getElementById("usernameList")
                        .appendChild(listItem);
                }
            }
        }

        if (usernameList.size >= 4) {
            startButton.style.display = "none";
            connection.send("startGame");
            return;
        } else if (usernameList.size < 2) {
            //if there are less than 2 players in the game the game cannot be started (start button is invisible)
            startButton.style.display = "none";
        }
        //otherwise a start button is visible and on click will start the game within 10 seconds
        startButton.addEventListener("click", function (e) {
            //when start game is clicked, makes it invisible and calls start countdown
            connection.send("startGame");
        });
    }
    function Game(usernameList) {
        const gameUserList = document.getElementById("GameuserList");
        gameUserList.innerHTML = ""; // Clear the previous user list
        if (usernameList) {
            for (let [key, value] of usernameList) {
                let listItem = document.createElement("li");
                listItem.classList.add("list-group-item", "text-start");
                listItem.style.width = "100%";
                listItem.style.height = "60px";
                listItem.style.fontWeight = "bold";
                listItem.style.backgroundColor = colormap[value];
                listItem.textContent =
                    key.toUpperCase() + "'s Score: " + scoremap[key];

                gameUserList.appendChild(listItem);
            }
        }

        populateWordGrid(buttonsList);
        started = true;
    }
    function populateWordGrid(buttonsList) {
        wordGrid.innerHTML = "";

        for (let i = 0; i < 50; i++) {
            const Row = document.createElement("div");
            Row.classList.add("d-flex", "flex-grow-1");

            for (let j = 0; j < 50; j++) {
                var Col = document.createElement("span");
                Col.classList.add("list-group-item", "text-start");
                Col.textContent = buttonsList[i][j].alphabet;
                Col.id = i + "," + j;
                Col.style.cursor = "pointer";
                Col.style.width = "2px";
                Col.style.height = "10px";
                Col.style.margin = "3px";
                Col.style.display = "flex";
                Col.style.justifyContent = "center";
                Col.style.alignItems = "center";
                Col.style.backgroundColor = buttonsList[i][j].color;
                Col.addEventListener(
                    "click",
                    ClickListener(Col, i, j)
                );
                Row.appendChild(Col);
            }
            wordGrid.appendChild(Row);
        }
    }



    
    function ClickListener(Col, i, j) {
        return function () {
            if(Col.style.backgroundColor !== "white")return;
            Col.style.backgroundColor = usernameList.get(username);
            connection.send("< " + username + " " + i + " " + j +" "+ usernameList.get(username))   
            if (userStartClick === null) {
                userStartClick = { i, j };
                console.log("startClick: ", userStartClick);
            } else if (userEndClick === null) {
                userEndClick = { i, j };
                console.log("endClick: ", userEndClick);
                connection.send(
                    ") " +
                        username +
                        " " +
                        userStartClick.i +
                        " " +
                        userStartClick.j +
                        " " +
                        userEndClick.i +
                        " " +
                        userEndClick.j
                );
                userStartClick = null;
                userEndClick = null;
            }
        };
    }
    function colorIn(){
        for(let i = 0; i < 50; i++){
            for(let j=0; j < 50; j++){
                const spanId = `${i},${j}`
                const getSpan = document.getElementById(spanId)
                if(getSpan === null){
                    return;
                }else{
                        const color = buttonsList[i][j].color
                        getSpan.style.backgroundColor = color;
                   }
                
            }
        }
    }
    
    function fillChat(){
        if(hasChildElements()){
            createChildElement(chatLog[(chatLog.length)-1])
            return;
        }
        chatLog.forEach(element => {
            createChildElement(element)
        });
    }

    function createChildElement(element){
        const Div = document.createElement("div")
        Div.style.width = "450px"
        Div.style.height = "100px"
        Div.style.overflowY = "hidden"
        Div.style.maxWidth = "450px"
        Div.style.maxHeight = "100px"
        Div.style.borderRadius = "5px"
        Div.classList.add("list-group-item", "justify-content-between", "bg-dark","mb-2" ,"text-white" ,"fs-5", "text-bold")
        const Span  = document.createElement("span")
        
        const paragraph = document.createElement("p")
        paragraph.classList.add("text-break")
        paragraph.textContent = element.message
        if(element.sender === username){
            Span.textContent = "ME:"
            Div.style.translate = "480px"
        }else{
            Span.textContent = element.sender + ":"
            Div.style.translate = "0px"
        }
        Div.appendChild(Span)
        Div.appendChild(paragraph)
        chatbox.appendChild(Div)
    }
    function hasChildElements(){
        const childNodes = Array.from(chatbox.childNodes).filter(node => node.nodeType === Node.ELEMENT_NODE)
        return childNodes.length > 0;
    }




    function startCountdown() {
        // 10 second countdown, displays the coundown timer
        //changes the text content of the Count span (so it displayes like 10, 9 , 8 ...)
        //when timer reaches 0 the countdown display and lobby become invisible, game screen becomes visible
        
        const Countdown = document.getElementById("Countdown");
        const Count = document.getElementById("Count");
        var timer = 10;
        startButton.style.display = "none";
        Countdown.style.display = "block";

        const interval = setInterval(() => {
            timer--;
            Count.textContent = timer;

            if (timer <= 0) {
                clearInterval(interval);
                Countdown.style.display = "none";
                LobbyScreen.style.display = "none";
                GameScreen.style.display = "block";
                Game(usernameList);
            }
        }, 100);
    }
</script>

<script></script>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
></script>

<style>
    @keyframes gradientAnimation {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }

    #TWSG {
        background: linear-gradient(to right, #ffffff, #9d9da2, #ffffff);
        background-size: 200% auto;
        color: transparent;
        -webkit-background-clip: text;
        animation: gradientAnimation 3s linear infinite;
    }
</style>
