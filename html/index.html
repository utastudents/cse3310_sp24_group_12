<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
    </head>
    <title>TWSG</title>

    <body class="bg-dark text-white">
        <nav class="navbar navbar-dark d-flex border-bottom border-white">
            <div
                class="container-fluid justify-content-evenly position-relative pt-3 pb-3"
            >
                <h1
                    id="TWSG"
                    class="navbar-brand font-weight-bold extra-bold position-absolute start-50 translate-middle-x"
                    title="The World Search Game"
                    style="font-size: 2em"
                >
                    TWSG
                </h1>
                <button
                    id="Chat"
                    class="btn btn-primary ms-auto mx-5"
                    type="button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasBottom"
                    aria-controls="offcanvasBottom"
                    style="display: none"
                >
                    OPEN CHAT
                </button>
            </div>
        </nav>

        <div
            class="offcanvas offcanvas-bottom bg-dark mx-auto"
            tabindex="-1"
            id="offcanvasBottom"
            aria-labelledby="offcanvasBottomLabel"
            style="width: 60%; height: 75%; overflow: hidden"
        >
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasBottomLabel">CHAT</h5>
                <button
                    type="button"
                    class="btn-close bg-white"
                    data-bs-dismiss="offcanvas"
                    aria-label="Close"
                ></button>
            </div>
            <div class="offcanvas-body small position-relative">
                <div
                    class="bg-secondary position-relative"
                    style="
                        overflow-x: hidden;
                        overflow-y: hidden;
                        max-height: 400px;
                        height: 75%;
                        max-width: 100%;
                        border-radius: 5px;
                    "
                >
                    <ul
                        id="chatLog"
                        class="list-group pt-2 mx-2 position-absolute bottom-0 start-0"
                    ></ul>
                </div>
                <span
                    class="position-absolute start-50 translate-middle-x fs-3"
                >
                    Enter Message</span
                >
                <form id="hit-send">
                    <input
                        class="position-absolute my-5 start-50 translate-middle-x w-50 text-break form"
                        type="text"
                        id="MessageInput"
                    />
                    <button
                        type="submit"
                        class="btn btn-primary my-5 position-absolute start-50 translate-middle-x"
                        style="translate: 300px"
                    >
                        SEND
                    </button>
                </form>
            </div>
        </div>

        <!--Login Screen Here -->
        <div id="LoginScreen" style="display: block">
            <div class="container-fluid row g-3 py-2 justify-content-center">
                <form id="usernameForm" class="col-6 text-center">
                    <div class="row mb-2">
                        <h3>
                            <label for="inputUsername" class="col-form-label">
                                Enter Username
                            </label>
                        </h3>
                    </div>
                    <div>
                        <input
                            type="text"
                            id="inputUsername"
                            class="form-control"
                        />
                    </div>
                    <div>
                        <span id="nameLength" class="form-text">
                            Must be atleast 3 characters.
                        </span>
                    </div>
                    <div>
                        <span id="usernameError" class="form-text text-danger">
                        </span>
                    </div>
                    <button
                        type="submit"
                        class="btn btn-primary mt-2"
                        style="width: 30%"
                    >
                        SUBMIT
                    </button>
                </form>
            </div>
        </div>

        <!--Lobby Screen Here -->
        <div id="LobbyScreen" style="display: none">
            <div class="container text-center mt-3">
                <h2>L O B B Y</h2>
            </div>

            <div
                class="d-flex align-items-center col card bg-secondary mx-auto mt-5"
                style="max-height: 300px; width: 300px"
            >
                <ul
                    id="usernameList"
                    class="list-group flex-grow-1"
                    style="height: 100%; width: 100%"
                ></ul>
            </div>
            <div
                class="d-flex justify-content-center align-items-center col mx-auto"
                style="max-height: 300px; width: 300px"
            >
                <button
                    id="startButton"
                    type="button"
                    class="btn btn-primary mt-2"
                    style="width: 50%; display: 'block'"
                >
                    START GAME
                </button>
                <div id="Countdown" class="mt-4" style="display: none">
                    Game starts in
                    <span
                        id="Count"
                        class="text-danger fw-bolder"
                        >5</span
                    >
                </div>
            </div>
        </div>

        <!-- Game Screen Here -->
        <div id="GameScreen" class="container-fluid mt-1" style="display: none">
            <div class="container text-center">
                <Span class="fw-bold">Game ends in</Span>
                <span id="gameTimer"> --:--<span>
            </div>
            <div class="row justify-content-start mx-3 pt-3">
                <div class="col-8 px-n2" >
                    <div
                        id="WordGrid"
                        class="d-flex card bg-secondary align-items-between justify-content-between"
                        style="
                            max-width: 710px;
                            max-height: 446px;
                            overflow-x: auto;
                            overflow-y: auto;
                        "
                    ></div>
                </div>
                <div class="col-4 px-n4">
                    <div
                        class="d-flex card bg-secondary"
                        style="max-height: 300px; width: 200px"
                    >
                        <ul
                            id="GameuserList"
                            class="list-group list-group-horizontal"
                            style="height: 100%; width: 100%"
                        ></ul>
                    </div>
                    <div class="mt-2" style="overflow-y: auto; max-height: 376px;">
                        <ul id="wordBank" class="list-group d-flex flex-wrap list-group-horizontal list-group-flush">

                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Leaderboard Screen Here -->
        <div id="LeaderboardScreen" class="container" style="display: none">
            <div class="row justify-content-center mt-5">
                <div class="col-md-6">
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h2 class="text-center">Leaderboard</h2>
                        </div>
                        <ul
                            id="leaderboardList"
                            class="list-group list-group-flush"
                        >
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="ServerExit" class="container" style="display: none;">
            <div class="container-fluid row g-3 py-2 justify-content-center text-center">
                <h3>Someone has left the server</h3>
                <p class="fw-bold text-danger" >Please refresh to find new game</p>
            </div>
        </div>

    </body>
</html>
<script>
    var idx = -1;
    var gameid = -1;
    class UserEvent {
        Button = -1;
        PlayerIdx = 0;
        GameId = 0;
    }
    var connection = null;

    var serverUrl;
    serverUrl =
        "ws://" +
        window.location.hostname +
        ":" +
        (parseInt(location.port) + 100);
    // Create the connection with the server
    connection = new WebSocket(serverUrl);

    connection.onopen = function (evt) {
        console.log("open");
    };
    connection.onclose = function (evt) {
        console.log("close");
    };
    const ServerExit = document.getElementById("ServerExit")
    const LoginScreen = document.getElementById("LoginScreen");
    const LobbyScreen = document.getElementById("LobbyScreen");
    const chat = document.getElementById("Chat");
    const chatbox = document.getElementById("chatLog");
    const Send = document.getElementById("hit-send");
    const MessageIn = document.getElementById("MessageInput");
    const WordBank = document.getElementById("wordBank")
    const LeaderboardScreen = document.getElementById("LeaderboardScreen")
    const size = 20;
    const LeaderboardList = document.getElementById("leaderboardList")
    const GameScreen = document.getElementById("GameScreen");
    var intervals = [];
    var username;
    var gametime = false
    var form = document.getElementById("usernameForm");
    var input = document.getElementById("inputUsername");
    var usernameError = document.getElementById("usernameError");
    var nameLength = document.getElementById("nameLength");
    var startButton = document.getElementById("startButton");
    var buttonsList;
    var wordBank;
    var chatLog;
    var leaderboard;
    var foundWords;
    var scoremap = new Map();
    var started = false;
    var userStartClick = null;
    var userEndClick = null;
    let colormap = {
        RED: "Crimson",
        GREEN: "MediumAquaMarine",
        BLUE: "CornflowerBlue",
        ORANGE: "DarkOrange",
        YELLOW: "Gold",
        PURPLE: "MediumSlateBlue",
        WHITE: "White",
    };
    const wordGrid = document.getElementById("WordGrid");

    connection.onmessage = function (evt) {
        var msg;
        msg = evt.data;

        console.log("Message received: " + msg);

        usernameError.textContent = "";

        if (msg == "startGame") {
            startCountdown();
            return;
        } else if (msg.includes("version")) {
            const obj = JSON.parse(msg);
            if (obj.version)
                document.title += " : " + obj.version;
        } else if (msg.includes("error")) {
            const obj = JSON.parse(msg);
            usernameError.textContent = obj.error;
            return;
        }else if(msg == "ServerExit"){
            connection.close(1000,"Exit server")
            clearIntervals();
            LoginScreen.style.display = "none";
            LobbyScreen.style.display = "none";
            GameScreen.style.display = "none";
            ServerExit.style.display = "block";
        }else if(msg == "countdown"){
            if(!gametime){
                gametime = true
                Gametimer();
            }
        }else {
            const obj = JSON.parse(msg);

            if ("YouAre" in obj) {
                if (obj.YouAre == "player_1") {
                    idx = 0;
                } else if (obj.YouAre == "player_2") {
                    idx = 1;
                } else if (obj.YouAre == "player_3") {
                    idx = 2;
                } else if (obj.YouAre == "player_4") {
                    idx = 3;
                }
                gameid = obj.GameId;
            }

            if (
                "gameState" in obj &&
                obj.gameState == 1 &&
                obj.GameId == gameid &&
                !started
            ) {
                startButton.style.display = "none";
                console.log("gameid: " + gameid);
                console.log("gameState: " + obj.gameState);
                startCountdown();
            }

            if ("loginManager" in obj && obj.GameId == gameid && !started) {
                usernameList = obj.loginManager.usernames;
                usernameList = new Map(Object.entries(usernameList));
                console.log("gameid: " + gameid);
                console.log("usernamelist: " + usernameList);
                if (usernameList.has(username)) {
                    LoginScreen.style.display = "none";
                    LobbyScreen.style.display = "block";
                    chat.style.display = "block";
                    input.value = "";
                    Lobby(usernameList);
                }
            }
            if ("grid" in obj && obj.GameId == gameid) {
                console.log("gameid: " + gameid);
                buttonsList = obj.grid.grid;
                wordBank = obj.grid.wordsInGrid
                foundWords = obj.grid.foundWords
                colorIn();
                updateWordBank();
               
            }
            if ("scores" in obj && obj.GameId == gameid && obj.gameState == 1) {
                scoremap = obj.scores.score;
                for (let key in scoremap) {
                    updateScore(key);
                }
            }

            if (
                "latestPlayer" in obj &&
                obj.GameId == gameid &&
                obj.gameState != 1
            ) {
                if (
                    obj.latestPlayer == "player_1" ||
                    obj.latestPlayer == "player_5"
                ) {
                    startButton.style.display = "none";
                } else {
                    startButton.style.display = "block";
                }
            }

            if ("chatLog" in obj && obj.GameId == gameid) {
                chatLog = obj.chatLog.chatLog;
                if (chatLog.length === 0) {
                    console.log("Empty chat");
                } else {
                    fillChat();
                }
            }
            if("leaderboard" in obj && obj.GameId == gameid){
                leaderboard = obj.leaderboard.score;
            }
        }
    };



    form.addEventListener("submit", function (e) {
        //take in user input (username)
        e.preventDefault();
        username = input.value;
        var newUser = {
            register: {
                username: username,
            },
            gameid: gameid,
        };
        connection.send(JSON.stringify(newUser));
    });

    Send.addEventListener("submit", function (e) {
        e.preventDefault();
        if (MessageIn.value.trim()) {
            var chatMessage = {
                incoming: {
                    from: username,
                },
                details: MessageIn.value,
            };
            connection.send(JSON.stringify(chatMessage));
        }
        MessageIn.value = "";
    });

    function Lobby(usernameList) {
        //lobby screen, for each username in usernamelist create new list element and populate the lobby list.

        if (usernameList) {
            for (let [key, value] of usernameList) {
                if (!document.getElementById(key)) {
                    let listItem = document.createElement("li");
                    listItem.classList.add("list-group-item", "text-center");
                    listItem.style.width = "100%";
                    listItem.style.height = "60px";
                    listItem.style.fontWeight = "bold";
                    listItem.textContent = key.toUpperCase();
                    listItem.id = key;
                    document
                        .getElementById("usernameList")
                        .appendChild(listItem);
                }
            }
        }

        if (usernameList.size >= 4) {
            startButton.style.display = "none";
            connection.send("startGame");
            return;
        } else if (usernameList.size < 2) {
            //if there are less than 2 players in the game the game cannot be started (start button is invisible)
            startButton.style.display = "none";
        }
        //otherwise a start button is visible and on click will start the game within 10 seconds
        startButton.addEventListener("click", function (e) {
            //when start game is clicked, makes it invisible and calls start countdown
            connection.send("startGame");
        });
    }
    function Game(usernameList) {
        const gameUserList = document.getElementById("GameuserList");
        gameUserList.innerHTML = ""; // Clear the previous user list
        if (usernameList) {
            for (let [key, value] of usernameList) {
                const listItem = document.createElement("li");
                listItem.id = key + "1";
                listItem.classList.add("list-group-item", "text-start");
                listItem.style.width = "100%";
                listItem.style.height = "60px";
                listItem.style.fontWeight = "bold";
                listItem.style.backgroundColor = colormap[value];
                gameUserList.appendChild(listItem);
                updateScore(key);
            }
        }

        populateWordGrid(buttonsList);
        fillWordBank();
        connection.send("startCountdown")
        started = true;
    }
    function populateWordGrid(buttonsList) {
        wordGrid.innerHTML = "";

        for (let i = 0; i < size; i++) {
            const Row = document.createElement("div");
            Row.classList.add("d-flex", "flex-grow-1");

            for (let j = 0; j < size; j++) {
                var Col = document.createElement("span");
                Col.classList.add("list-group-item", "text-start");
                Col.textContent = buttonsList[i][j].alphabet;
                Col.id = i + "," + j;
                Col.style.cursor = "pointer";
                Col.style.width = "20px";
                Col.style.height = "20px";
                Col.style.margin = "1px";
                Col.style.display = "flex";
                Col.style.justifyContent = "center";
                Col.style.alignItems = "center";
                Col.style.backgroundColor = buttonsList[i][j].color;
                Col.addEventListener("click", ClickListener(Col, i, j));
                Row.appendChild(Col);
            }
            wordGrid.appendChild(Row);
        }
    }


    function updateWordBank(){
        for(let i = 0; i < wordBank.length -1; i++){
            const bank = document.getElementById(wordBank[i].word)
            if(bank === null)return;
            if(foundWords.some(item => item.word === wordBank[i].word)){
                bank.style.backgroundColor = "seagreen"
            }
        }
    }
    function fillWordBank(){
        for(let i =0; i < wordBank.length -1; i++){
            const word = document.createElement("li");
            word.id = wordBank[i].word
            word.classList.add("list-group-item","col-3")
            word.textContent = wordBank[i].word;
            WordBank.append(word);
        }
    }

    function updateScore(key) {
        const keyElement = document.getElementById(key + "1");
        if (keyElement === null) {
            return;
        }
        keyElement.textContent =
            key.toUpperCase() + "'s score: " + scoremap[key];
    }

    function FillLeaderBoard(){
        var i = 0;
        for(let key in leaderboard){
            const element = document.createElement("li")
            element.classList.add("list-group-item","text-center", "fw-bolder")
            element.innerText = key + " : " + leaderboard[key]
            LeaderboardList.appendChild(element)
            i++;
        }
    }

    function ClickListener(Col, i, j) {
        return function () {
            if (Col.style.backgroundColor !== "white") return;
            Col.style.backgroundColor = usernameList.get(username);
            var click = {
                click: {
                    username: username,
                    x: i,
                    y: j,
                    color: usernameList.get(username),
                },
                gameid: gameid,
            };

            connection.send(JSON.stringify(click));

            if (userStartClick === null) {
                userStartClick = { i, j };
            } else if (userEndClick === null) {
                userEndClick = { i, j };

                var clickCoords = {
                    startClick: {
                        x: userStartClick.i,
                        y: userStartClick.j,
                    },
                    endClick: {
                        x: userEndClick.i,
                        y: userEndClick.j,
                    },
                    gameid: gameid,
                    color: usernameList.get(username),
                    username: username,
                };
                connection.send(JSON.stringify(clickCoords));
                userStartClick = null;
                userEndClick = null;
            }
        };
    }

    function colorIn() {
        for (let i = 0; i < size; i++) {
            for (let j = 0; j < size; j++) {
                const spanId = `${i},${j}`;
                const getSpan = document.getElementById(spanId);
                if (getSpan === null) {
                    return;
                } else {
                    const color =
                        colormap[buttonsList[i][j].color.toUpperCase()];
                    getSpan.style.backgroundColor = color;
                }
            }
        }
    }

    function fillChat() {
        if (hasChildElements()) {
            createChildElement(chatLog[chatLog.length - 1]);
            return;
        }
        chatLog.forEach((element) => {
            createChildElement(element);
        });
    }

    function createChildElement(element) {
        const Div = document.createElement("div");
        Div.style.width = "420px";
        Div.style.height = "100px";
        Div.style.overflowY = "hidden";
        Div.style.maxWidth = "420px";
        Div.style.maxHeight = "100px";
        Div.style.borderRadius = "5px";
        Div.classList.add(
            "list-group-item",
            "justify-content-between",
            "bg-dark",
            "mb-2",
            "text-white",
            "fs-5",
            "text-bold"
        );
        const Span = document.createElement("span");

        const paragraph = document.createElement("p");
        paragraph.classList.add("text-break");
        paragraph.textContent = element.message;
        if (element.sender === username) {
            Span.textContent = "ME:";
            Div.style.translate = "300px";
        } else {
            Span.textContent = element.sender + ":";
            Div.style.translate = "0px";
        }
        Div.appendChild(Span);
        Div.appendChild(paragraph);
        chatbox.appendChild(Div);
    }
    function hasChildElements() {
        const childNodes = Array.from(chatbox.childNodes).filter(
            (node) => node.nodeType === Node.ELEMENT_NODE
        );
        return childNodes.length > 0;
    }

    function startCountdown() {
        // 10 second countdown, displays the coundown timer
        //changes the text content of the Count span (so it displayes like 10, 9 , 8 ...)
        //when timer reaches 0 the countdown display and lobby become invisible, game screen becomes visible

        const Countdown = document.getElementById("Countdown");
        const Count = document.getElementById("Count");
        var timer = 5;
        startButton.style.display = "none";
        Countdown.style.display = "block";

        const interval = setInterval(() => {
            timer--;
            Count.textContent = timer;

            if (timer <= 0) {
                clearInterval(interval);
                Countdown.style.display = "none";
                LobbyScreen.style.display = "none";
                GameScreen.style.display = "block";
                Game(usernameList);
            }
        }, 1000);
        intervals.push(interval)
        
    }

    function Gametimer(){
        const gametime = document.getElementById("gameTimer")
        var startTime = Date.now()
        var timer = 600
        var interval = setInterval(updateTimer,1000)
        intervals.push(interval)
        function updateTimer(){
            const elapsed = Math.floor((Date.now()-startTime)/1000)
            const remaining = timer - elapsed
            var minutes = Math.floor(remaining/60)
            var seconds = remaining%60
            gametime.textContent = minutes + " : " + seconds.toString().padStart(2,'0')
            if(remaining <= 0){
                clearInterval(interval)
                GameScreen.style.display = "none";
                LeaderboardScreen.style.display = "block"
                FillLeaderBoard();
            }else if(remaining <= 90){
                gametime.classList.add("text-danger")
            }
        }

    }

    function clearIntervals(){
        intervals.forEach(interval => clearInterval(interval))
        intervals = []
        console.log("timers and intervals stopped")
    }

</script>

<script></script>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
></script>

<style>
    @keyframes gradientAnimation {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }

    #TWSG {
        background: linear-gradient(to right, #ffffff, #9d9da2, #ffffff);
        background-size: 200% auto;
        color: transparent;
        -webkit-background-clip: text;
        animation: gradientAnimation 3s linear infinite;
    }
</style>

<style>
    ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
    }
    ::-webkit-scrollbar-thumb {
        background-color: darkgrey;
        border-radius: 5px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 5px;
    }
</style>